#!/usr/bin/env bash

# Rofi note launcher script for Neovim + PARA method

VAULT_DIR="$HOME/notes"

# Ensure root directory exists
mkdir -p "$VAULT_DIR"

# Rofi menu options
options="fzf
ripgrep
create note"

# Show rofi menu
choice=$(echo -e "$options" | rofi -dmenu -i -p "" -theme-str 'window {width: 10%;} listview {lines: 3; columns: 1;} element selected {background-color: #2a2a38; text-color: #c5c9c5;} inputbar {enabled: false;}')

# Strip whitespace for case matching
choice_clean=$(echo "$choice" | xargs)

case "$choice_clean" in
    "fzf")
        # Use fzf in floating kitty with preview
        kitty --class kitty-notes -e bash -c "
            cd '$VAULT_DIR' && \
            selected=\$(find . -type f -name '*.md' | \
                fzf --preview 'bat --style=numbers --color=always {}' \
                    --preview-window=right:60% \
                    --height=100%) && \
            [ -n \"\$selected\" ] && nvim \"\$selected\"
        " &
        ;;
    
"ripgrep")
    kitty --class kitty-notes -e bash -c '
        cd "'"$VAULT_DIR"'" && \
        selected=$(fzf --disabled --ansi \
            --bind "start:reload(rg --max-depth 6 --column --line-number --no-heading --color=always --smart-case -- \"\")" \
            --bind "change:reload:rg --max-depth 6 --column --line-number --no-heading --color=always --smart-case -- {q} || true" \
            --delimiter ":" \
            --preview "bat --style=numbers --color=always --highlight-line {2} {1}" \
            --preview-window="right:60%:+{2}-/2") && \
        file=$(echo "$selected" | cut -d":" -f1) && \
        line=$(echo "$selected" | cut -d":" -f2) && \
        [ -n "$file" ] && nvim "+$line" "$file"
    ' &
    ;;
    
    "create note")
        # Prompt for note name
        note_name=$(rofi -dmenu -p "Note name (blank for timestamp)" -theme-str 'window {width: 25%;} listview {enabled: false;}')
        
        if [ -z "$note_name" ]; then
            # If blank, use timestamp
            timestamp=$(date +%Y-%m-%d-%H%M)
            note_file="$VAULT_DIR/$timestamp.md"
        else
            # Sanitize filename
            safe_name=$(echo "$note_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
            note_file="$VAULT_DIR/$safe_name.md"
        fi
        
        # Create with template if doesn't exist
        if [ ! -f "$note_file" ]; then
            echo "# $(basename "$note_file" .md)" > "$note_file"
            echo "" >> "$note_file"
            echo "tags: " >> "$note_file"
            echo "" >> "$note_file"
            echo "## Overview" >> "$note_file"
            echo "" >> "$note_file"
        fi
        
        # Open in nvim
        kitty --class kitty-notes -e nvim "$note_file" &
        ;;
esac
