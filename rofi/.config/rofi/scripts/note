#!/usr/bin/env bash

# Rofi note launcher script for Neovim + PARA method

VAULT_DIR="$HOME/notes"

# Ensure PARA directories exist
mkdir -p "$VAULT_DIR/0temp"
mkdir -p "$VAULT_DIR/1-projects"
mkdir -p "$VAULT_DIR/2-areas"
mkdir -p "$VAULT_DIR/3-resources"

# Rofi menu options with pango markup for colors (Kanagawa Dragon theme)
# Dragon theme colors: red #c4746e, orange #c4b28a, yellow #c4b28a, green #8a9a7b, blue #8ba4b0, purple #a292a3
options="<span foreground='#8ba4b0'>fzf</span>\n<span foreground='#a292a3'>ripgrep</span>\nquick note\nproject note\narea note\nresource note"

# Show rofi menu with markup enabled and darker selection color
choice=$(echo -e "$options" | rofi -dmenu -i -p "Notes" -markup-rows -theme-str 'window {width: 15%;} listview {lines: 6; columns: 1;} element selected {background-color: #2a2a38; text-color: #c5c9c5;}')

# Strip the markup tags for case matching
choice_clean=$(echo "$choice" | sed 's/<[^>]*>//g')

case "$choice_clean" in
    "fzf")
        # Open nvim with file picker (fuzzy find)
        kitty -e nvim -c "lua require('snacks').picker.files({ cwd = '$VAULT_DIR' })" &
        ;;
    
    "ripgrep")
        # Open nvim with grep/live search
        kitty -e nvim -c "lua require('snacks').picker.grep({ cwd = '$VAULT_DIR' })" &
        ;;
    
    "quick note")
        # Generate timestamp filename: YYYY-MM-DD-HHMM.md
        timestamp=$(date +%Y-%m-%d-%H%M)
        note_file="$VAULT_DIR/0temp/$timestamp.md"
        
        # Create with template
        echo "# Quick Note" > "$note_file"
        echo "" >> "$note_file"
        echo "tags: " >> "$note_file"
        echo "" >> "$note_file"
        echo "## Overview" >> "$note_file"
        echo "" >> "$note_file"
        
        # Open in nvim
        kitty -e nvim "$note_file" &
        ;;
    
    "project note")
        # Prompt for project name
        project_name=$(rofi -dmenu -p "File name" -theme-str 'window {width: 25%;} listview {enabled: false;}')
        
        if [ -n "$project_name" ]; then
            # Sanitize filename
            safe_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
            note_file="$VAULT_DIR/1-projects/$safe_name.md"
            
            # Create with template
            if [ ! -f "$note_file" ]; then
                echo "# $project_name" > "$note_file"
                echo "" >> "$note_file"
                echo "tags: #project" >> "$note_file"
                echo "" >> "$note_file"
                echo "## Overview" >> "$note_file"
                echo "" >> "$note_file"
                echo "## Goals" >> "$note_file"
                echo "" >> "$note_file"
                echo "## Tasks" >> "$note_file"
                echo "" >> "$note_file"
            fi
            
            # Open in nvim
            kitty -e nvim "$note_file" &
        fi
        ;;
    
    "area note")
        # Prompt for area name
        area_name=$(rofi -dmenu -p "File name" -theme-str 'window {width: 25%;} listview {enabled: false;}')
        
        if [ -n "$area_name" ]; then
            safe_name=$(echo "$area_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
            note_file="$VAULT_DIR/2-areas/$safe_name.md"
            
            # Create with template
            if [ ! -f "$note_file" ]; then
                echo "# $area_name" > "$note_file"
                echo "" >> "$note_file"
                echo "tags: #area" >> "$note_file"
                echo "" >> "$note_file"
                echo "## Overview" >> "$note_file"
                echo "" >> "$note_file"
            fi
            
            # Open in nvim
            kitty -e nvim "$note_file" &
        fi
        ;;
    
    "resource note")
        # Prompt for resource name
        resource_name=$(rofi -dmenu -p "File name" -theme-str 'window {width: 25%;} listview {enabled: false;}')
        
        if [ -n "$resource_name" ]; then
            safe_name=$(echo "$resource_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
            note_file="$VAULT_DIR/3-resources/$safe_name.md"
            
            # Create with template
            if [ ! -f "$note_file" ]; then
                echo "# $resource_name" > "$note_file"
                echo "" >> "$note_file"
                echo "tags: #resource" >> "$note_file"
                echo "" >> "$note_file"
                echo "## Overview" >> "$note_file"
                echo "" >> "$note_file"
            fi
            
            # Open in nvim
            kitty -e nvim "$note_file" &
        fi
        ;;
esac
