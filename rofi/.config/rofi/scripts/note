#!/usr/bin/env bash

VAULT_DIR="$HOME/notes"
mkdir -p "$VAULT_DIR"

# Updated Order
options="create note
fzf
ripgrep"

choice=$(echo -e "$options" | rofi -dmenu -i -p "" -theme-str 'window {width: 10%;} listview {lines: 3; columns: 1;} element selected {background-color: #2a2a38; text-color: #c5c9c5;} inputbar {enabled: false;}')
choice_clean=$(echo "$choice" | xargs)

case "$choice_clean" in
    "fzf")
        kitty --class kitty-notes -e bash -c "
            cd '$VAULT_DIR' && \
            selected=\$(find . -type f -name '*.md' | \
                fzf --preview 'bat --style=numbers --color=always {}' \
                    --preview-window=right:60% \
                    --height=100%) && \
            [ -n \"\$selected\" ] && nvim \"\$selected\"
        " &
        ;;
    
    "ripgrep")
        kitty --class kitty-notes -e bash -c '
            cd "'"$VAULT_DIR"'" && \
            selected=$(fzf --disabled --ansi \
                --prompt "Search Content > " \
                --bind "change:reload:rg --column --line-number --no-heading --color=always --smart-case -- {q} || true" \
                --delimiter ":" \
                --preview "bat --style=numbers --color=always --highlight-line {2} {1}" \
                --preview-window="right:60%:+{2}-/2") && \
            [ -n "$selected" ] && \
            file=$(echo "$selected" | cut -d":" -f1) && \
            line=$(echo "$selected" | cut -d":" -f2) && \
            nvim "+$line" "$file"
        ' &
        ;;
    
    "create note")
        # Capture input and exit code
        note_name=$(rofi -dmenu -p "Note name (blank for timestamp)" -theme-str 'window {width: 25%;} listview {enabled: false;}')
        rofi_exit=$?
        
        # Exit immediately if user pressed Escape (exit code 1)
        if [ $rofi_exit -ne 0 ]; then
            exit 0
        fi
        
        if [ -z "$note_name" ]; then
            timestamp=$(date +%Y-%m-%d-%H%M)
            note_file="$VAULT_DIR/$timestamp.md"
        else
            safe_name=$(echo "$note_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
            note_file="$VAULT_DIR/$safe_name.md"
        fi
        
        if [ ! -f "$note_file" ]; then
            echo "# $(basename "$note_file" .md)" > "$note_file"
            echo "" >> "$note_file"
            echo "tags: " >> "$note_file"
            echo "" >> "$note_file"
            echo "## Overview" >> "$note_file"
            echo "" >> "$note_file"
        fi
        
        kitty --class kitty-notes -e nvim "$note_file" &
        ;;
esac
