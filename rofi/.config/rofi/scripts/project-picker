#!/usr/bin/env bash

PROJECTS_DIR="$HOME/projects"

# Sanitize session name: replaces dots/spaces with underscores
function sanitize() { echo "$1" | tr ' ./' '___'; }

# ============================================================================
# AUTO-RESTORE SESSIONS AFTER REBOOT
# ============================================================================
if ! tmux list-sessions &>/dev/null 2>&1; then
    if [ -f "$HOME/.tmux/resurrect/last" ]; then
        tmux start-server
        tmux run-shell "$HOME/.tmux/plugins/tmux-resurrect/scripts/restore.sh"
        sleep 1
    fi
fi

# 1. Gather Data
# Removed Pango markup to prevent color overriding and ensure theme consistency
active_sessions=$(tmux list-sessions -F "#S ●" 2>/dev/null)

# Get project directories
all_projects=$(find "$PROJECTS_DIR" -maxdepth 1 -mindepth 1 -type d ! -name "archive" -printf "%f\n")

# 2. Combine and Sort
combined_list=$(echo -e "${active_sessions}\n${all_projects}")

# 3. Rofi Selection
# Removed -theme-str argument to allow your global Gruvbox Rofi theme to take control
selected_raw=$(echo "$combined_list" | rofi -dmenu -i -p "Project")

[ -z "$selected_raw" ] && exit 0

# 4. Processing Selection
# Simplified sed to only remove the status indicator " ●"
selected=$(echo "$selected_raw" | sed 's/ ●//')
session_name=$(sanitize "$selected")
project_path="$PROJECTS_DIR/$selected"

# 5. Execution
if ! tmux has-session -t "$session_name" 2>/dev/null; then
    # Fallback to HOME if directory doesn't exist (for existing sessions not in projects folder)
    [ ! -d "$project_path" ] && project_path="$HOME"
    tmux new-session -d -s "$session_name" -c "$project_path"
fi

if [ -n "$TMUX" ]; then
    tmux switch-client -t "$session_name"
else
    kitty --detach tmux attach-session -t "$session_name"
fi
