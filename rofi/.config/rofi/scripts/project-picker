#!/usr/bin/env bash

# Project Picker - Rofi script for tmux session management
# Lists projects in ~/projects and attaches to or creates tmux sessions

PROJECTS_DIR="$HOME/projects"

# Check if projects directory exists
if [ ! -d "$PROJECTS_DIR" ]; then
    rofi -e "Projects directory not found: $PROJECTS_DIR"
    exit 1
fi

# Get list of directories in ~/projects
projects=$(find "$PROJECTS_DIR" -maxdepth 1 -mindepth 1 -type d -printf "%f\n" | sort)

# Check if there are any projects
if [ -z "$projects" ]; then
    rofi -e "No projects found in $PROJECTS_DIR"
    exit 1
fi

# Show rofi menu and get selected project (this runs outside of Kitty)
selected=$(echo "$projects" | rofi -dmenu -i -p "Select Project")

# Exit if nothing selected
if [ -z "$selected" ]; then
    exit 0
fi

# Get the full path to the project
project_path="$PROJECTS_DIR/$selected"

# Use the directory name as the session name
session_name="$selected"

# Check if we're already in a tmux session
if [ -n "$TMUX" ]; then
    # We're inside tmux, so we need to switch sessions
    if tmux has-session -t "$session_name" 2>/dev/null; then
        # Session exists, switch to it
        tmux switch-client -t "$session_name"
    else
        # Session doesn't exist, create it and switch
        tmux new-session -d -s "$session_name" -c "$project_path"
        tmux switch-client -t "$session_name"
    fi
else
    # We're not in tmux, launch kitty with tmux
    if tmux has-session -t "$session_name" 2>/dev/null; then
        # Session exists, attach to it in kitty
        kitty tmux attach-session -t "$session_name" &
    else
        # Session doesn't exist, create and attach in kitty
        kitty tmux new-session -s "$session_name" -c "$project_path" &
    fi
fi
