#!/usr/bin/env bash

PROJECTS_DIR="$HOME/projects"

# Sanitize session name: replaces dots/spaces with underscores
function sanitize() { echo "$1" | tr ' ./' '___'; }

# 1. Gather Data
# Get active sessions and format with Pango markup for Green text
active_sessions=$(tmux list-sessions -F "#S" 2>/dev/null | \
    awk '{print "<span foreground=\"#a6e22e\">" $0 " (active)</span>"}')

# Get project directories, excluding "archive"
all_projects=$(find "$PROJECTS_DIR" -maxdepth 1 -mindepth 1 -type d ! -name "archive" -printf "%f\n")

# 2. Combine and Sort (Active sessions on top)
combined_list=$(echo -e "${active_sessions}\n${all_projects}")

# 3. Rofi Selection (markup-rows enabled for colors)
selected_raw=$(echo "$combined_list" | rofi -dmenu -i -markup-rows -p "Project" -theme-str 'window {width: 20%;}')
[ -z "$selected_raw" ] && exit 0

# 4. Processing Selection
# Remove Pango tags and "(active)" suffix to get the raw name
selected=$(echo "$selected_raw" | sed -e 's/<[^>]*>//g' -e 's/ (active)//')
session_name=$(sanitize "$selected")
project_path="$PROJECTS_DIR/$selected"

# 5. Execution
if ! tmux has-session -t "$session_name" 2>/dev/null; then
    tmux new-session -d -s "$session_name" -c "$project_path"
fi

if [ -n "$TMUX" ]; then
    tmux switch-client -t "$session_name"
else
    kitty --detach tmux attach-session -t "$session_name"
fi
